import telebot
from telebot import types
import sqlite3
import os
from dotenv import load_dotenv

# --- Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸ ID Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° ---
load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
ADMIN_ID = int(os.getenv("ADMIN_ID"))

bot = telebot.TeleBot(BOT_TOKEN)

# --- ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ---
conn = sqlite3.connect("subscribers.db", check_same_thread=False)
cursor = conn.cursor()
cursor.execute("""
CREATE TABLE IF NOT EXISTS subscribers (
    user_id INTEGER PRIMARY KEY,
    language TEXT
)
""")
conn.commit()

# --- ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹ ---
kb_subscribe = types.ReplyKeyboardMarkup(resize_keyboard=True)
kb_subscribe.add(types.KeyboardButton("âœ… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ"))

kb_unsubscribe = types.ReplyKeyboardMarkup(resize_keyboard=True)
kb_unsubscribe.add(types.KeyboardButton("âŒ ĞÑ‚Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ"))

kb_languages = types.ReplyKeyboardMarkup(resize_keyboard=True)
kb_languages.add("ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹", "ğŸ‡¬ğŸ‡§ ĞĞ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹")
kb_languages.add("ğŸ‡µğŸ‡± ĞŸĞ¾Ğ»ÑŒÑĞºĞ¸Ğ¹", "ğŸ‡ªğŸ‡¸ Ğ˜ÑĞ¿Ğ°Ğ½ÑĞºĞ¸Ğ¹")
kb_languages.add("ğŸ‡©ğŸ‡ª ĞĞµĞ¼ĞµÑ†ĞºĞ¸Ğ¹", "ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†ÑƒĞ·ÑĞºĞ¸Ğ¹")
kb_languages.add("ğŸ‡°ğŸ‡¿ ĞšĞ°Ğ·Ğ°Ñ…ÑĞºĞ¸Ğ¹", "ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ğ¸Ğ½ÑĞºĞ¸Ğ¹")

# --- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ ---
def is_subscribed(user_id: int) -> bool:
    cursor.execute("SELECT 1 FROM subscribers WHERE user_id = ?", (user_id,))
    return cursor.fetchone() is not None

# --- /start ---
@bot.message_handler(commands=["start"])
def start(message):
    user_id = message.from_user.id
    if is_subscribed(user_id):
        bot.send_message(user_id, "Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‹ âœ…", reply_markup=kb_unsubscribe)
    else:
        bot.send_message(user_id, "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ.", reply_markup=kb_subscribe)

# --- ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ° ---
@bot.message_handler(func=lambda m: m.text == "âœ… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ")
def subscribe(message):
    user_id = message.from_user.id
    cursor.execute("INSERT OR IGNORE INTO subscribers (user_id) VALUES (?)", (user_id,))
    conn.commit()
    bot.send_message(user_id, "Ğ’Ñ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸ÑÑŒ! Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº:", reply_markup=kb_languages)

# --- Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑĞ·Ñ‹ĞºĞ° ---
@bot.message_handler(func=lambda m: m.text in [
    "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹","ğŸ‡¬ğŸ‡§ ĞĞ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹","ğŸ‡µğŸ‡± ĞŸĞ¾Ğ»ÑŒÑĞºĞ¸Ğ¹","ğŸ‡ªğŸ‡¸ Ğ˜ÑĞ¿Ğ°Ğ½ÑĞºĞ¸Ğ¹",
    "ğŸ‡©ğŸ‡ª ĞĞµĞ¼ĞµÑ†ĞºĞ¸Ğ¹","ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†ÑƒĞ·ÑĞºĞ¸Ğ¹","ğŸ‡°ğŸ‡¿ ĞšĞ°Ğ·Ğ°Ñ…ÑĞºĞ¸Ğ¹","ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ğ¸Ğ½ÑĞºĞ¸Ğ¹"
])
def choose_language(message):
    user_id = message.from_user.id
    language = message.text
    cursor.execute("UPDATE subscribers SET language = ? WHERE user_id = ?", (language, user_id))
    conn.commit()

    greetings = {
        "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹": "Ğ’Ñ‹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ Ñ€ÑƒÑÑĞºĞ¸Ğ¹ ÑĞ·Ñ‹Ğº ğŸ‡·ğŸ‡º\nĞ¯ Ğ¼Ğ¾Ğ³Ñƒ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ†ĞµĞ½Ñ‹ Ğ½Ğ° AliExpress, Allegro, Temu, Alibaba, Banggood. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ ÑÑÑ‹Ğ»ĞºÑƒ â€” Ğ¸ Ñ ÑĞ¾Ğ¾Ğ±Ñ‰Ñƒ, ĞµÑĞ»Ğ¸ Ñ†ĞµĞ½Ğ° ÑƒĞ¿Ğ°Ğ´ĞµÑ‚!",
        "ğŸ‡¬ğŸ‡§ ĞĞ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹": "You selected English ğŸŒ\nI can track prices on AliExpress, Allegro, Temu, Alibaba, Banggood. Send a link â€” and I will notify if the price drops!",
        "ğŸ‡µğŸ‡± ĞŸĞ¾Ğ»ÑŒÑĞºĞ¸Ğ¹": "WybraÅ‚eÅ› jÄ™zyk polski ğŸ‡µğŸ‡±\nÅšledzÄ™ ceny na AliExpress, Allegro, Temu, Alibaba, Banggood. WyÅ›lij link â€” powiadomiÄ™ CiÄ™ o zmianie ceny!",
        "ğŸ‡ªğŸ‡¸ Ğ˜ÑĞ¿Ğ°Ğ½ÑĞºĞ¸Ğ¹": "Has seleccionado EspaÃ±ol ğŸ‡ªğŸ‡¸\nPuedo rastrear precios en AliExpress, Allegro, Temu, Alibaba, Banggood. EnvÃ­a un enlace y te avisarÃ© si baja el precio!",
        "ğŸ‡©ğŸ‡ª ĞĞµĞ¼ĞµÑ†ĞºĞ¸Ğ¹": "Du hast Deutsch ğŸ‡©ğŸ‡ª gewÃ¤hlt\nIch verfolge Preise auf AliExpress, Allegro, Temu, Alibaba, Banggood. Sende einen Link â€” ich benachrichtige dich bei PreisÃ¤nderungen!",
        "ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†ÑƒĞ·ÑĞºĞ¸Ğ¹": "Vous avez choisi FranÃ§ais ğŸ‡«ğŸ‡·\nJe peux suivre les prix sur AliExpress, Allegro, Temu, Alibaba, Banggood. Envoyez un lien â€” je vous avertirai si le prix baisse!",
        "ğŸ‡°ğŸ‡¿ ĞšĞ°Ğ·Ğ°Ñ…ÑĞºĞ¸Ğ¹": "Ğ¡Ñ–Ğ· Ò›Ğ°Ğ·Ğ°Ò› Ñ‚Ñ–Ğ»Ñ–Ğ½ Ñ‚Ğ°Ò£Ğ´Ğ°Ğ´Ñ‹Ò£Ñ‹Ğ· ğŸ‡°ğŸ‡¿\nĞœĞµĞ½ AliExpress, Allegro, Temu, Alibaba, Banggood ÑĞ°Ğ¹Ñ‚Ñ‚Ğ°Ñ€Ñ‹Ğ½Ğ´Ğ°Ò“Ñ‹ Ğ±Ğ°Ò“Ğ°Ğ»Ğ°Ñ€Ğ´Ñ‹ Ğ±Ğ°Ò›Ñ‹Ğ»Ğ°Ğ¹Ğ¼Ñ‹Ğ½. Ğ¡Ñ–Ğ»Ñ‚ĞµĞ¼ĞµĞ½Ñ– Ğ¶Ñ–Ğ±ĞµÑ€Ñ–Ò£Ñ–Ğ· â€” Ğ±Ğ°Ò“Ğ° Ñ‚Ó©Ğ¼ĞµĞ½Ğ´ĞµÑĞµ Ñ…Ğ°Ğ±Ğ°Ñ€Ğ»Ğ°Ğ¹Ğ¼Ñ‹Ğ½!",
        "ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ğ¸Ğ½ÑĞºĞ¸Ğ¹": "Ğ’Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ»Ğ¸ ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºÑƒ ğŸ‡ºğŸ‡¦\nĞ¯ Ğ²Ñ–Ğ´ÑĞ»Ñ–Ğ´ĞºĞ¾Ğ²ÑƒÑ Ñ†Ñ–Ğ½Ğ¸ Ğ½Ğ° AliExpress, Allegro, Temu, Alibaba, Banggood. ĞĞ°Ğ´Ñ–ÑˆĞ»Ñ–Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ â€” Ñ– Ñ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»Ñ, ÑĞºÑ‰Ğ¾ Ñ†Ñ–Ğ½Ğ° Ğ·Ğ½Ğ¸Ğ·Ğ¸Ñ‚ÑŒÑÑ!"
    }

    bot.send_message(user_id, greetings[language], reply_markup=kb_unsubscribe)

# --- ĞÑ‚Ğ¿Ğ¸ÑĞºĞ° ---
@bot.message_handler(func=lambda m: m.text == "âŒ ĞÑ‚Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ")
def unsubscribe(message):
    user_id = message.from_user.id
    cursor.execute("DELETE FROM subscribers WHERE user_id = ?", (user_id,))
    conn.commit()
    bot.send_message(user_id, "Ğ’Ñ‹ Ğ¾Ñ‚Ğ¿Ğ¸ÑĞ°Ğ»Ğ¸ÑÑŒ ğŸ”•", reply_markup=kb_subscribe)

# --- ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° ---
@bot.message_handler(commands=["count"])
def count_subscribers(message):
    if message.from_user.id != ADMIN_ID:
        bot.reply_to(message, "â›” Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°")
        return
    cursor.execute("SELECT COUNT(*) FROM subscribers")
    count = cursor.fetchone()[0]
    bot.reply_to(message, f"ğŸ“Š ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹: {count}")

@bot.message_handler(commands=["subscribers"])
def list_subscribers(message):
    if message.from_user.id != ADMIN_ID:
        bot.reply_to(message, "â›” Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°")
        return
    cursor.execute("SELECT user_id, language FROM subscribers")
    rows = cursor.fetchall()
    if not rows:
        bot.reply_to(message, "ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ² ğŸ˜¢")
        return
    text = "ğŸ“‹ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ²:\n\n"
    for user_id, lang in rows:
        text += f"ğŸ‘¤ ID: {user_id} | Ğ¯Ğ·Ñ‹Ğº: {lang}\n"
    bot.reply_to(message, text)

# --- Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½) ---
@bot.message_handler(commands=["broadcast"])
def broadcast(message):
    if message.from_user.id != ADMIN_ID:
        bot.reply_to(message, "â›” Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°")
        return
    msg = message.text.replace("/broadcast ", "", 1)
    cursor.execute("SELECT user_id FROM subscribers")
    users = cursor.fetchall()
    for (user_id,) in users:
        try:
            bot.send_message(user_id, msg)
        except Exception:
            continue
    bot.reply_to(message, "âœ… Ğ Ğ°ÑÑÑ‹Ğ»ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°!")

# --- Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ° ---
print("Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½...")
bot.infinity_polling()
